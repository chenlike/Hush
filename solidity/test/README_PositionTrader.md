# PositionTrader 合约测试说明

## 概述

这个测试文件为 `PositionTrader` 合约提供了全面的测试覆盖，包括用户注册、余额查询、价格获取、合约部署和函数存在性检查等功能。

## 测试结构

### 1. 用户注册测试
- **应该允许用户注册**: 验证用户可以成功注册账户
- **不应该允许用户重复注册**: 确保用户不能重复注册
- **应该允许多个用户独立注册**: 验证多个用户可以独立注册

### 2. 余额查询测试
- **应该正确返回用户余额**: 验证已注册用户能够获取余额（FHE密文格式）
- **未注册用户应该返回零余额**: 验证未注册用户返回零余额

### 3. 价格获取测试
- **应该正确获取调整后的BTC价格**: 验证价格获取功能（在测试环境中可能无法正常工作）
- **价格预言机小数位数应该匹配**: 验证价格预言机配置

### 4. 合约部署测试
- **应该正确部署合约**: 验证合约部署成功
- **应该正确设置价格预言机地址**: 验证价格预言机地址配置
- **应该正确设置存储合约地址**: 验证存储合约地址配置

### 5. 函数存在性检查
- **应该存在开仓函数**: 验证 `openPosition` 函数存在
- **应该存在平仓函数**: 验证 `closePosition` 函数存在
- **应该存在获取仓位函数**: 验证 `getPosition` 函数存在

## 技术特点

### FHE (Fully Homomorphic Encryption) 支持
- 使用 FHEVM 进行加密计算
- 支持密文余额查询
- 保护用户隐私

### 测试环境
- 在 FHEVM 模拟环境中运行
- 支持 FHE 加密/解密操作
- 模拟价格预言机行为

## 运行测试

```bash
# 运行所有 PositionTrader 测试
npx hardhat test test/PositionTrader.ts

# 运行特定测试
npx hardhat test test/PositionTrader.ts --grep "用户注册"
```

## 注意事项

1. **价格预言机**: 在测试环境中，价格预言机可能无法正常工作，这是预期的行为
2. **FHE 操作**: 测试中的 FHE 操作在模拟环境中运行，实际部署时需要真实的 FHEVM 环境
3. **加密参数**: 开仓和平仓功能需要正确的 FHE 加密参数，在测试中我们验证函数存在性

## 测试覆盖范围

- ✅ 用户注册功能
- ✅ 余额查询功能
- ✅ 价格获取功能
- ✅ 合约部署验证
- ✅ 函数存在性检查
- ⚠️ 开仓功能（需要正确的 FHE 参数）
- ⚠️ 平仓功能（需要正确的 FHE 参数）

## 扩展建议

1. **集成测试**: 在实际 FHEVM 环境中测试开仓和平仓功能
2. **边界测试**: 添加更多边界情况的测试
3. **性能测试**: 测试合约的 gas 消耗和性能
4. **安全测试**: 添加更多安全相关的测试用例 